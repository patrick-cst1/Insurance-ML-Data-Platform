trigger:
  branches:
    include:
      - main

stages:
  - stage: Deploy_Fabric
    displayName: Deploy to Microsoft Fabric
    jobs:
      - deployment: deploy_fabric
        displayName: Deploy Workspace
        environment: fabric-insurance
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '3.9'
                  displayName: 'Use Python 3.9'
                
                - script: |
                    pip install -r requirements.txt
                    pip install pyyaml requests
                  displayName: 'Install dependencies'
                
                - task: AzureKeyVault@2
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    KeyVaultName: '$(keyVaultName)'
                    SecretsFilter: '*'
                  displayName: 'Fetch secrets from Key Vault'
                
                - script: |
                    python framework/scripts/deploy_to_fabric.py
                  displayName: 'Deploy to Fabric Workspace'
                  env:
                    FABRIC_TOKEN: $(fabric_token)
                    COSMOS_ENDPOINT: $(cosmos_endpoint)
                    COSMOS_KEY: $(cosmos_key)
                
                - script: |
                  echo "Deployment summary:"
                  echo "- Workspace: Insurance-ML-Platform"
                  echo "- Components: Lakehouses (3), KQL DB (1), Pipelines (2)"
                  echo "- Status: SUCCESS âœ“"
                  displayName: 'Deployment summary'
